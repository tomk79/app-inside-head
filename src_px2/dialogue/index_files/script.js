(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}function n(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,"string");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}function i(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}var o=new WeakMap;const r=function(){return e=function e(t){var n,r,s,a,c;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c="",function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}(s=this,a=o),a.set(s,c),n=o,r=t.template||"",n.set(i(n,this),r)},(n=[{key:"ask",value:function(e){return new Promise((function(t,n){$.ajax({url:"./index_files/apis/query.php",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify({messages:e}),headers:{"X-CSRF-TOKEN":$("meta[name=csrf-token]").attr("content")},async:!0}).done((function(e){t(e)})).fail((function(e){n(e)}))}))}},{key:"bindTemplate",value:function(e){var t,n=(this,(t=o).get(i(t,this)));return n||(n="${mainTheme}"),(n=n.split("${mainTheme}").join(e.mainTheme)).split("${currentIdea}").join(e.currentIdea)}}])&&t(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n}();function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,c(i.key),i)}}function c(e){var t=function(e,t){if("object"!=s(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,"string");if("object"!=s(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==s(t)?t:t+""}function u(e,t,n){l(e,t),t.set(e,n)}function l(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function f(e,t){return e.get(h(e,t))}function p(e,t,n){return e.set(h(e,t),n),n}function h(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}var m=new WeakMap,y=new WeakMap,v=new WeakMap,b=new WeakMap,w=new WeakMap,d=new WeakMap,g=new WeakMap,k=new WeakMap,T=new WeakSet;function S(){var e,t=this;p(b,this,(e=f(b,this),++e)),f(b,this)>10||"stop"==f(m,this)||(f(w,this).length||f(w,this).push({role:"user",content:f(k,this).presenter.bindTemplate({mainTheme:f(y,this)})}),f(k,this).presenter.ask(f(w,this)).then((function(e){f(w,t).push(e.choices[0].message),p(v,t,e.choices[0].message.content),f(d,t).call(t,{phase:"idation",currentIdea:f(v,t)}),h(T,t,j).call(t)})).catch((function(e){console.error(e)})))}function j(){var e=this,t=[];return f(k,this).reviewers.forEach((function(n){var i=[{role:"user",content:n.bindTemplate({mainTheme:f(y,e),currentIdea:f(v,e)})}];t.push(n.ask(i))})),Promise.allSettled(t).then((function(t){var n=h(T,e,E).call(e,t),i=[];t.forEach((function(e,t){var o=e.value.choices[0].message;o.stance=n.scores[t],i.push(o)})),f(d,e).call(e,{phase:"review",reviews:i}),n.total<=n.agree?e.stopDiscussion():(f(w,e).push({role:"user",content:"可決しませんでした。修正案を提案してください。"}),h(T,e,S).call(e))})).catch((function(e){console.error(e)}))}function E(e){var t={agree:0,opposition:0,unknown:0,total:0,scores:[]};return e.forEach((function(e,n){e.value.choices[0].message.content.match(/^[\s\S]*?(賛成|反対)/);var i=RegExp.$1;t.total++,"賛成"==i?(t.agree++,t.scores.push(!0)):"反対"==i?(t.opposition++,t.scores.push(!1)):(t.unknown++,t.scores.push(null))})),t}var P,W=new(function(){return e=function e(){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,t=T),t.add(this),u(this,m,"stop"),u(this,y,void 0),u(this,v,void 0),u(this,b,0),u(this,w,[]),u(this,d,void 0),u(this,g,void 0),u(this,k,void 0)},(t=[{key:"init",value:function(e){var t=this;p(m,this,"stop"),p(y,this,e.mainTheme),p(v,this,""),p(b,this,0),p(w,this,[]),p(d,this,e.onmessage||function(){}),p(g,this,e.onstop||function(){}),p(k,this,{presenter:new r({template:e.members.presenter.template||""}),reviewers:[]}),e.members.reviewers.forEach((function(e){f(k,t).reviewers.push(new r({template:e.template||""}))}))}},{key:"startDiscussion",value:function(){p(m,this,"playing"),h(T,this,S).call(this)}},{key:"stopDiscussion",value:function(){p(m,this,"stop"),f(g,this).call(this)}}])&&a(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}()),M=$("#cont-discussion-log"),O=$("#cont-btn-start"),x=$("#cont-btn-stop");x.attr({disabled:!0}),O.on("click",(function(){O.attr({disabled:!0}),x.attr({disabled:!1});var e=$('textarea[name="main-theme"]').val();new Promise((function(e,t){P?e(P):window.getCsrfToken((function(t){e(P=t)}))})).then((function(e){return new Promise((function(e,t){$.ajax({url:"./index_files/apis/get_committee_settings.php",type:"get",dataType:"json",async:!0}).done((function(t){e(t.members)})).fail((function(e){console.error(e)}))}))})).then((function(t){M.html(""),W.init({mainTheme:e,members:t,onmessage:function(e){console.log("=-=-=-=-= message:",e),M.append("<p>".concat(JSON.stringify(e),"</p>"))},onstop:function(){O.attr({disabled:!1}),x.attr({disabled:!0})}}),W.startDiscussion()}))})),x.on("click",(function(){W.stopDiscussion()}))})();
//# sourceMappingURL=script.js.map